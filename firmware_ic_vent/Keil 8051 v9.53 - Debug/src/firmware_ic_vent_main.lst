C51 COMPILER V9.53.0.0   FIRMWARE_IC_VENT_MAIN                                             04/14/2023 15:18:04 PAGE 1   


C51 COMPILER V9.53.0.0, COMPILATION OF MODULE FIRMWARE_IC_VENT_MAIN
OBJECT MODULE PLACED IN .\src\firmware_ic_vent_main.OBJ
COMPILER INVOKED BY: c:\SiliconLabs\SimplicityStudio\v4\developer\toolchains\keil_8051\9.53\BIN\C51.exe C:\Users\Rajko\S
                    -implicityStudio\v4_workspace\firmware_ic_vent\src\firmware_ic_vent_main.c OMF2 SMALL DEBUG OBJECTEXTEND ROM(LARGE) WARNI
                    -NGLEVEL(2) FLOATFUZZY(3) OPTIMIZE(8,SPEED) DEFINE(DEBUG=1) INTVECTOR(0X0000) INTPROMOTE INCDIR(C:\Users\Rajko\Simplicity
                    -Studio\v4_workspace\firmware_ic_vent\inc;C:/SiliconLabs/SimplicityStudio/v4/developer/sdks/8051/v4.1.1//Device/shared/si
                    -8051base;C:/SiliconLabs/SimplicityStudio/v4/developer/sdks/8051/v4.1.1//Device/EFM8BB3/inc) PRINT(.\src\firmware_ic_vent
                    -_main.lst) COND PAGEWIDTH(120) PAGELENGTH(65) OBJECT(.\src\firmware_ic_vent_main.OBJ)

line level    source

   1          //=========================================================
   2          // src/firmware_ic_vent_main.c: generated by Hardware Configurator
   3          //
   4          // This file will be updated when saving a document.
   5          // leave the sections inside the "$[...]" comment tags alone
   6          // or they will be overwritten!!
   7          //=========================================================
   8          
   9          //-----------------------------------------------------------------------------
  10          // Includes
  11          //-----------------------------------------------------------------------------
  12          #include <SI_EFM8BB3_Register_Enums.h>                  // SFR declarations
  13          #include "InitDevice.h"
  14          #include "pin_names.h"
  15          #include <STRING.H>
  16          #include <STDIO.H>
  17          #include <MATH.H>
  18          #include "timers.h"
  19          uint8_t TASK_select = 0;
  20          uint8_t LID_select = 0;
  21          uint8_t last_sw_lid_state = 1;
  22          uint8_t last_sw_vent_state = 1;
  23          bit swlidpressed = 0;
  24          bit swventpressed1 = 0;
  25          bit swventpressed = 0;
  26          uint8_t lidcalibstate = 0;
  27          
  28          bit button_state = 0;
  29          bit button_state1 = 0;
  30          bit errorLID = 0;
  31          bit errorVENT = 0;
  32          
  33          #define TASK1                                   0
  34          #define TASK2                                   1
  35          #define TASK3                                   2
  36          #define TASK4                                   3
  37          #define TASK5                                   4
  38          
  39          #define LID_OPEN                                1
  40          #define LID_OPENING                             2
  41          #define LID_OPENING_STARTING    3
  42          #define LID_CLOSING_STARTING    4
  43          #define LID_CLOSING                             5
  44          #define LID_CLOSED                              6
  45          #define LID_ERROR                               7
  46          #define LID_ERROR_RECALIBRATE   8
  47          #define LID_MOTOR_OPEN                  1
  48          #define LID_MOTOR_CLOSE                 0
  49          #define LID_MOTOR_STOP                  2
  50          #define LID_MOTOR_BRAKE                 3
  51          
C51 COMPILER V9.53.0.0   FIRMWARE_IC_VENT_MAIN                                             04/14/2023 15:18:04 PAGE 2   

  52          #define VENT_STOPPED                            0
  53          #define VENT_OUT                                        1
  54          #define VENT_IN                                         2
  55          #define VENT_STOPPING                           3
  56          #define VENT_IN_STARTING                        4
  57          #define VENT_OUT_STARTING                       5
  58          #define VENT_ERROR                                      6
  59          
  60          #define VENT_MOTOR_IN                   1
  61          #define VENT_MOTOR_OUT                  0
  62          #define VENT_MOTOR_STOP                 2
  63          #define VENT_MOTOR_BRAKE                3
  64          
  65          uint8_t lidstate = LID_OPEN;
  66          uint8_t ventstate = VENT_STOPPED;
  67          uint32_t xdata checkTimer1 = 0;
  68          uint32_t xdata checkTimer2 = 0;
  69          uint32_t xdata checkTimer3 = 0;
  70          uint32_t xdata checkTimer4 = 0;
  71          uint32_t xdata checkTimer5 = 0;
  72          uint32_t xdata timerlid = 0;
  73          uint32_t xdata timervent = 0;
  74          uint32_t xdata timer1 = 0;
  75          uint32_t xdata timer2 = 0;
  76          
  77          extern uint32_t newKey;
  78          extern uint32_t oldKey;
  79          // $[Generated Includes]
  80          // [Generated Includes]$
  81          
  82          //-----------------------------------------------------------------------------
  83          // SiLabs_Startup() Routine
  84          // ----------------------------------------------------------------------------
  85          // This function is called immediately after reset, before the initialization
  86          // code is run in SILABS_STARTUP.A51 (which runs before main() ). This is a
  87          // useful place to disable the watchdog timer, which is enable by default
  88          // and may trigger before main() in some instances.
  89          //-----------------------------------------------------------------------------
  90          void SiLabs_Startup(void) {
  91   1              // $[SiLabs Startup]
  92   1              // [SiLabs Startup]$
  93   1      }
  94          
  95          //-----------------------------------------------------------------------------
  96          // main() Routine
  97          // ----------------------------------------------------------------------------
  98          void init_ir_receiver() {
  99   1              /*      // Stop timer3 and clear overflow flag
 100   1               TMR3CN0 &= ~TMR3CN0_TR3__BMASK;
 101   1               TMR3CN0 &= ~TMR3CN0_TF3H__BMASK;
 102   1               TMR3CN0 &= ~TMR3CN0_TF3L__BMASK;
 103   1      
 104   1               // Set timer3 reload value to maximum
 105   1      
 106   1               TMR3CN0 |= TMR3CN0_TR3__RUN;
 107   1               TMR3 = 0;
 108   1               */
 109   1      
 110   1              TH0 = 208;  // Reload the timer value for 1ms Delay 0xB0E
 111   1              TL0 = 198;
 112   1      
 113   1              TCON_TR0 = 1;   // Start the Timer
 114   1              IE_ET0 = 1;       // Enable the Timer0 Interrupt
C51 COMPILER V9.53.0.0   FIRMWARE_IC_VENT_MAIN                                             04/14/2023 15:18:04 PAGE 3   

 115   1      
 116   1              TCON_IT0 = 1;       // Configure INT0 falling edge interrupt
 117   1              IE_EX0 = 1;       // Enable the INT0 External Interrupt
 118   1      
 119   1              IE_EA = 1;       // Enable the Global Interrupt bit
 120   1      
 121   1      }
 122          void setlidmotor(int state) {
 123   1              switch (state) {
 124   2              case LID_MOTOR_OPEN: {
 125   3                      ML_2 = 0;
 126   3                      ML_1 = 1;
 127   3      
 128   3                      break;
 129   3      
 130   3              }
 131   2              case LID_MOTOR_CLOSE: {
 132   3                      ML_2 = 1;
 133   3                      ML_1 = 0;
 134   3      
 135   3                      break;
 136   3      
 137   3              }
 138   2              case LID_MOTOR_STOP: {
 139   3                      ML_2 = 0;
 140   3                      ML_1 = 0;
 141   3      
 142   3                      break;
 143   3      
 144   3              }
 145   2              case LID_MOTOR_BRAKE: {
 146   3                      ML_2 = 1;
 147   3                      ML_1 = 1;
 148   3      
 149   3                      break;
 150   3      
 151   3              }
 152   2              }
 153   1      }
 154          
 155          void setventmotor(int state) {
 156   1              switch (state) {
 157   2              case VENT_MOTOR_IN: {
 158   3                      MV_2 = 0;
 159   3                      MV_1 = 0;
 160   3      
 161   3                      break;
 162   3      
 163   3              }
 164   2              case VENT_MOTOR_OUT: {
 165   3                      MV_2 = 1;
 166   3                      MV_1 = 0;
 167   3      
 168   3                      break;
 169   3      
 170   3              }
 171   2              case VENT_MOTOR_STOP: {
 172   3                      MV_2 = 1;
 173   3                      MV_1 = 1;
 174   3      
 175   3                      break;
 176   3      
 177   3              }
C51 COMPILER V9.53.0.0   FIRMWARE_IC_VENT_MAIN                                             04/14/2023 15:18:04 PAGE 4   

 178   2              case VENT_MOTOR_BRAKE: {
 179   3                      MV_2 = 0;
 180   3                      MV_1 = 1;
 181   3      
 182   3                      break;
 183   3      
 184   3              }
 185   2              }
 186   1      }
 187          
 188          int main(void) {
 189   1              // Call hardware initialization routine
 190   1              enter_DefaultMode_from_RESET();
 191   1              init_ir_receiver();
 192   1              currentMillis = millis;
 193   1              LED_LID = 1;
 194   1              LED_VENT = 1;
 195   1              LED_RAIN = 1;
 196   1              //lid motor stopped
 197   1              ML_2 = 0;
 198   1              ML_1 = 0;
 199   1      
 200   1              //setlidmotor(LID_MOTOR_CLOSE);
 201   1      
 202   1              //fan motor stopped
 203   1              MV_2 = 1;
 204   1              MV_1 = 1;
 205   1      
 206   1              swlidpressed = 1;
 207   1      
 208   1              while (true) {
 209   2      
 210   2                      switch (TASK_select) {
 211   3      
 212   3                      case TASK1: {
 213   4      
 214   4                              if (millis - checkTimer1 > 100) {
 215   5      
 216   5                                      checkTimer1 = millis;
 217   5      
 218   5                                      switch (lidstate) {
 219   6                                      case LID_CLOSED: //poklopac zatvoren
 220   6                                      {
 221   7                                              if (swlidpressed) {
 222   8                                                      swlidpressed = 0;
 223   8                                                      //blinkingLID=1;
 224   8                                                      lidstate = LID_OPENING_STARTING;
 225   8                                                      setlidmotor(LID_MOTOR_OPEN);
 226   8                                                      timerlid = millis;
 227   8      
 228   8                                              }
 229   7      
 230   7                                              break;
 231   7                                      }
 232   6                                      case LID_CLOSING_STARTING: { //ignore CS
 233   7                                              if (millis - timerlid > 200) {
 234   8                                                      lidstate = LID_CLOSING;
 235   8                                                      timerlid = millis;
 236   8      
 237   8                                              }
 238   7      
 239   7                                              break;
 240   7                                      }
C51 COMPILER V9.53.0.0   FIRMWARE_IC_VENT_MAIN                                             04/14/2023 15:18:04 PAGE 5   

 241   6                                      case LID_CLOSING: {
 242   7                                              if (swlidpressed) {
 243   8                                                      swlidpressed = 0;
 244   8                                                      lidstate = LID_CLOSED;
 245   8                                                      setlidmotor(LID_MOTOR_STOP);
 246   8                                                      break;
 247   8      
 248   8                                              }
 249   7                                              if (millis - timerlid > 20000 && !ML_CS) {
 250   8                                                      // zatvaranje traje predugo a nemamo CS
 251   8                                                      setlidmotor(LID_MOTOR_STOP);
 252   8                                                      swlidpressed = 0;
 253   8                                                      lidstate = LID_ERROR;
 254   8                                              } else if (ML_CS) {
 255   8                                                      setlidmotor(LID_MOTOR_STOP);
 256   8                                                      lidstate = LID_CLOSED;
 257   8                                                      swlidpressed = 0;
 258   8                                              }
 259   7      
 260   7                                              break;
 261   7                                      }
 262   6                                      case LID_OPENING_STARTING: { //ignore CS
 263   7                                              if (millis - timerlid > 200) {
 264   8                                                      lidstate = LID_OPENING;
 265   8                                                      timerlid = millis;
 266   8      
 267   8                                              }
 268   7      
 269   7                                              break;
 270   7                                      }
 271   6                                      case LID_OPENING: { //scan current sense and time opening // also button will stop motor
 272   7                                              if (swlidpressed) {
 273   8                                                      swlidpressed = 0;
 274   8                                                      lidstate = LID_OPEN;
 275   8                                                      setlidmotor(LID_MOTOR_STOP);
 276   8                                                      break;
 277   8      
 278   8                                              }
 279   7                                              if (millis - timerlid > 20000 && !ML_CS) {
 280   8                                                      // opening too long go to recalibrate
 281   8                                                      setlidmotor(LID_MOTOR_STOP);
 282   8                                                      swlidpressed = 0;
 283   8                                                      lidstate = LID_ERROR_RECALIBRATE;
 284   8                                              }else if (millis - timerlid < 15000 && ML_CS) { //opening shorter than usual - goto recalibrate
 285   8                                                      setlidmotor(LID_MOTOR_STOP);
 286   8                                                      swlidpressed = 0;
 287   8                                                      lidstate = LID_ERROR_RECALIBRATE;
 288   8                                              }
 289   7      
 290   7      
 291   7                                              else if (ML_CS){ //we have openned stop motor {
 292   8                                                      setlidmotor(LID_MOTOR_STOP);
 293   8                                                      lidstate = LID_OPEN;
 294   8                                                      swlidpressed = 0;
 295   8                                              }
 296   7      
 297   7                                              break;
 298   7                                      }
 299   6      
 300   6                                      case LID_OPEN: {
 301   7                                              if (swlidpressed) {
 302   8                                                      swlidpressed = 0;
 303   8                                                      //      LED_LID = 1;
C51 COMPILER V9.53.0.0   FIRMWARE_IC_VENT_MAIN                                             04/14/2023 15:18:04 PAGE 6   

 304   8                                                      if (ventstate == VENT_OUT || ventstate == VENT_IN || ventstate == VENT_OUT_STARTING || ventstate == 
             -VENT_IN_STARTING) {
 305   9                                                              ventstate = VENT_STOPPING;
 306   9                                                              setventmotor(VENT_MOTOR_BRAKE);
 307   9                                                      }
 308   8                                                      lidstate = LID_CLOSING_STARTING;
 309   8                                                      setlidmotor(LID_MOTOR_CLOSE);
 310   8                                                      timerlid = millis;
 311   8      
 312   8                                              }
 313   7      
 314   7                                              break;
 315   7                                      }
 316   6                                      case LID_ERROR: {
 317   7                                              if (swlidpressed) {
 318   8      
 319   8                                                      swlidpressed = 0;
 320   8                                                      lidstate = LID_CLOSING_STARTING;
 321   8                                                      setlidmotor(LID_MOTOR_CLOSE);
 322   8      
 323   8                                              }
 324   7      
 325   7                                              break;
 326   7      
 327   7                                      }
 328   6                                      case LID_ERROR_RECALIBRATE:
 329   6                                      {
 330   7                                              switch (lidcalibstate) {
 331   8      
 332   8                                                                                                      case 0: { // lets try to close lid
 333   9      
 334   9                                                                                                      swlidpressed = 0;
 335   9                                                                                                      lidcalibstate = 1;
 336   9                                                                                                      setlidmotor(LID_MOTOR_CLOSE);
 337   9                                                                                                      timerlid = millis;
 338   9                                                                                                      break;
 339   9      
 340   9      
 341   9                                                                                                      }
 342   8                                                                                                      case 1: {
 343   9      
 344   9                                                                                                              if (millis - timerlid > 200) {
 345  10                                                                                                                      lidcalibstate = 2;
 346  10                                                                                                                      timerlid = millis;
 347  10      
 348  10                                                                                                                      }
 349   9      
 350   9                                                                                                               break;
 351   9      
 352   9      
 353   9                                                                                                      }
 354   8                                                                                                      case 2: {
 355   9      
 356   9                                                                                                              if (millis - timerlid > 20000 && !ML_CS) {
 357  10                                                                                                              // zatvaranje traje predugo a nemamo CS u trajnoj smo greski;
 358  10                                                                                                                      swlidpressed = 0; //ponisti gumb
 359  10                                                                                                              setlidmotor(LID_MOTOR_STOP);
 360  10                                                                                                              lidstate = LID_ERROR;
 361  10                                                                                                              } else if (ML_CS) { //zatvorili smo - treba probati otvoriti
 362  10                                                                                                              setlidmotor(LID_MOTOR_STOP);
 363  10                                                                                                              lidcalibstate = 3;
 364  10                                                                                                              timerlid = millis;
 365  10                                                                                                              }
C51 COMPILER V9.53.0.0   FIRMWARE_IC_VENT_MAIN                                             04/14/2023 15:18:04 PAGE 7   

 366   9      
 367   9                                                                                                               break;
 368   9      
 369   9      
 370   9                                                                                                      }
 371   8                                                                                                      case 3: { // lets try to open lid
 372   9      
 373   9                                                                                                      swlidpressed = 0;
 374   9                                                                                                      lidcalibstate = 4;
 375   9                                                                                                      setlidmotor(LID_MOTOR_OPEN);
 376   9                                                                                                      timerlid = millis;
 377   9                                                                                                      break;
 378   9      
 379   9      
 380   9                                                                                                      }
 381   8      
 382   8                                                                                                      case 4: {
 383   9      
 384   9                                                                                                              if (millis - timerlid > 200) {
 385  10                                                                                                                      lidcalibstate = 5;
 386  10                                                                                                                      timerlid = millis;
 387  10      
 388  10                                                                                                                      }
 389   9      
 390   9                                                                                                               break;
 391   9      
 392   9      
 393   9                                                                                                      }
 394   8                                                                                                      case 5: {
 395   9      
 396   9                                                                                                              if (millis - timerlid > 20000 && !ML_CS) {
 397  10                                                                                                                      // opening too long go to recalibrate
 398  10                                                                                                                      setlidmotor(LID_MOTOR_STOP);
 399  10                                                                                                                      swlidpressed = 0;
 400  10                                                                                                                      lidcalibstate = 10; //nismo uspjeli otvoriti zatvori i odi u grešku
 401  10                                                                                                              }else if (millis - timerlid < 15000 && ML_CS) { //opening shorter - zatvori i greška
 402  10                                                                                                                      setlidmotor(LID_MOTOR_STOP);
 403  10                                                                                                                      swlidpressed = 0;
 404  10                                                                                                                      lidcalibstate = 10; //nismo uspjeli otvoriti nešto je zapelo - idi u grepjku
 405  10                                                                                                              }
 406   9      
 407   9      
 408   9                                                                                                              else if (ML_CS){ // otvorili smo ... sad zatvaramo i ako uspijemo zatvorit sve je ok.
 409  10                                                                                                                      setlidmotor(LID_MOTOR_STOP);
 410  10                                                                                                                      lidcalibstate = 6;
 411  10                                                                                                                      swlidpressed = 0;
 412  10                                                                                                              }
 413   9      
 414   9                                                                                                               break;
 415   9      
 416   9      
 417   9                                                                                                      }
 418   8                                                                                                      case 6: { // lets try to close lid
 419   9      
 420   9                                                                                                      swlidpressed = 0;
 421   9                                                                                                      lidcalibstate = 7;
 422   9                                                                                                      setlidmotor(LID_MOTOR_CLOSE);
 423   9                                                                                                      timerlid = millis;
 424   9                                                                                                      break;
 425   9      
 426   9      
 427   9                                                                                                      }
 428   8                                                                                                      case 7: {
C51 COMPILER V9.53.0.0   FIRMWARE_IC_VENT_MAIN                                             04/14/2023 15:18:04 PAGE 8   

 429   9      
 430   9                                                                                                              if (millis - timerlid > 200) {
 431  10                                                                                                                      lidcalibstate = 8;
 432  10                                                                                                                      timerlid = millis;
 433  10      
 434  10                                                                                                                      }
 435   9      
 436   9                                                                                                               break;
 437   9      
 438   9      
 439   9                                                                                                      }
 440   8                                                                                                      case 8: {
 441   9      
 442   9                                                                                                              if (millis - timerlid > 20000 && !ML_CS) {
 443  10                                                                                                              // zatvaranje traje predugo a nemamo CS u trajnoj smo greski;
 444  10                                                                                                                      swlidpressed = 0; //ponisti gumb
 445  10                                                                                                              setlidmotor(LID_MOTOR_STOP);
 446  10                                                                                                              lidstate = LID_ERROR;
 447  10                                                                                                              lidcalibstate = 0;
 448  10                                                                                                              }else if (millis - timerlid < 15000 && ML_CS) { //opening shorter - zatvori i greška
 449  10                                                                                                                      setlidmotor(LID_MOTOR_STOP);
 450  10                                                                                                                      swlidpressed = 0;
 451  10                                                                                                                      lidcalibstate = 0; //nismo uspjeli otvoriti nešto je zapelo - idi u grepjku
 452  10                                                                                                                      lidstate = LID_ERROR;
 453  10                                                                                                              }
 454   9                                                                                                              else if (ML_CS) { //zatvorili smo do kraja
 455  10                                                                                                              setlidmotor(LID_MOTOR_STOP);
 456  10                                                                                                              lidcalibstate = 0;
 457  10                                                                                                              timerlid = millis;
 458  10                                                                                                              lidstate = LID_CLOSED;
 459  10      
 460  10                                                                                                              }
 461   9      
 462   9                                                                                                               break;
 463   9      
 464   9      
 465   9                                                                                                      }
 466   8                                                                                                      case 10: { // lets try to close lid
 467   9      
 468   9                                                                                                      swlidpressed = 0;
 469   9                                                                                                      lidcalibstate = 11;
 470   9                                                                                                      setlidmotor(LID_MOTOR_CLOSE);
 471   9                                                                                                      timerlid = millis;
 472   9                                                                                                      break;
 473   9      
 474   9      
 475   9                                                                                                      }
 476   8                                                                                                      case 11: {
 477   9      
 478   9                                                                                                              if (millis - timerlid > 200) {
 479  10                                                                                                                      lidcalibstate = 12;
 480  10                                                                                                                      timerlid = millis;
 481  10      
 482  10                                                                                                                      }
 483   9      
 484   9                                                                                                               break;
 485   9      
 486   9      
 487   9                                                                                                      }
 488   8                                                                                                      case 12: {
 489   9      
 490   9                                                                                                              if (millis - timerlid > 20000 && !ML_CS) {
 491  10                                                                                                              // zatvaranje traje predugo a nemamo CS u trajnoj smo greski;
C51 COMPILER V9.53.0.0   FIRMWARE_IC_VENT_MAIN                                             04/14/2023 15:18:04 PAGE 9   

 492  10                                                                                                                      swlidpressed = 0; //ponisti gumb
 493  10                                                                                                              setlidmotor(LID_MOTOR_STOP);
 494  10                                                                                                              lidstate = LID_ERROR;
 495  10                                                                                                              lidcalibstate = 0;}
 496   9                                                                                                              else if (ML_CS) { //zatvorili smo do kraja
 497  10                                                                                                              setlidmotor(LID_MOTOR_STOP);
 498  10                                                                                                              lidcalibstate = 0;
 499  10                                                                                                              timerlid = millis;
 500  10                                                                                                              lidstate = LID_ERROR;
 501  10      
 502  10                                                                                                              }
 503   9      
 504   9                                                                                                               break;
 505   9      
 506   9      
 507   9                                                                                                      }
 508   8      
 509   8                                                                                                      break;
 510   8      
 511   8                                                                                      }
 512   7      
 513   7                                      }
 514   6      
 515   6      
 516   6                                      }
 517   5                              }
 518   4      
 519   4                              TASK_select++;
 520   4                              break;
 521   4                      }
 522   3                      case TASK2: { //check rain sensor
 523   4      
 524   4                              if (millis - checkTimer1 > 100) {
 525   5                                      /*      if (blinkingLID) LED_RAIN = !LED_RAIN;
 526   5                                       if (blinkingVENT) LED_RAIN = !LED_RAIN;
 527   5                                       */
 528   5                                      checkTimer1 = millis;
 529   5      
 530   5                                      switch (ventstate) {
 531   6                                      case VENT_STOPPED: {
 532   7                                              if (swventpressed) {
 533   8                                                      swventpressed = 0;
 534   8                                                      //LED_VENT = 1;
 535   8                                                      //blinkingVENT=1;
 536   8                                                      ventstate = VENT_OUT_STARTING;
 537   8                                                      setventmotor(VENT_MOTOR_OUT);
 538   8                                                      timervent = millis;
 539   8      
 540   8                                              }
 541   7                                              if (swventpressed1) {
 542   8                                                                                              swventpressed1 = 0;
 543   8                                                                                              //LED_VENT = 1;
 544   8                                                                                              //blinkingVENT=1;
 545   8                                                                                              ventstate = VENT_IN_STARTING;
 546   8                                                                                              setventmotor(VENT_MOTOR_IN);
 547   8                                                                                              timervent = millis;
 548   8      
 549   8                                                                                      }
 550   7      
 551   7      
 552   7                                              break;
 553   7                                      }
 554   6                                      case VENT_OUT_STARTING: {
C51 COMPILER V9.53.0.0   FIRMWARE_IC_VENT_MAIN                                             04/14/2023 15:18:04 PAGE 10  

 555   7                                              { //ignore CS
 556   8                                                      if (millis - timervent > 1000) {
 557   9                                                              ventstate = VENT_OUT;
 558   9                                                              timervent = millis;
 559   9      
 560   9                                                      }
 561   8      
 562   8                                                      break;
 563   8                                              }
 564   7      
 565   7                                              break;
 566   7                                      }
 567   6                                      case VENT_IN_STARTING: {
 568   7                                                                              { //ignore CS
 569   8                                                                                      if (millis - timervent > 1000) {
 570   9                                                                                              ventstate = VENT_IN;
 571   9                                                                                              timervent = millis;
 572   9      
 573   9                                                                                      }
 574   8      
 575   8                                                                                      break;
 576   8                                                                              }
 577   7      
 578   7                                                                              break;
 579   7                                                                      }
 580   6                                      case VENT_OUT: {
 581   7                                              if (swventpressed) {
 582   8                                                      swventpressed = 0;
 583   8                                                      ventstate = VENT_STOPPING;
 584   8                                                      setventmotor(VENT_MOTOR_BRAKE);
 585   8      
 586   8                                              } else if (MV_CS) {
 587   8      
 588   8                                                      setventmotor(VENT_MOTOR_STOP);
 589   8                                                      ventstate = VENT_ERROR;
 590   8                                                      swventpressed = 0;
 591   8      
 592   8                                              }
 593   7      
 594   7                                              break;
 595   7                                      }
 596   6                                      case VENT_STOPPING: {
 597   7                                              if (millis - timervent > 200) {
 598   8      
 599   8                                                      ventstate = VENT_STOPPED;
 600   8                                                      setventmotor(VENT_MOTOR_STOP);
 601   8                                                      swventpressed = 0;
 602   8                                                      timervent = millis;
 603   8      
 604   8                                              }
 605   7      
 606   7                                              break;
 607   7                                      }
 608   6                                      case VENT_IN: {
 609   7                                                                              if (swventpressed) {
 610   8                                                                                      swventpressed = 0;
 611   8                                                                                      ventstate = VENT_STOPPING;
 612   8                                                                                      setventmotor(VENT_MOTOR_BRAKE);
 613   8      
 614   8                                                                              }
 615   7                                                                              else if (swventpressed1){
 616   8                                                                                      swventpressed1 = 0;
 617   8                                                                                      ventstate = VENT_STOPPING;
C51 COMPILER V9.53.0.0   FIRMWARE_IC_VENT_MAIN                                             04/14/2023 15:18:04 PAGE 11  

 618   8                                                                                      setventmotor(VENT_MOTOR_BRAKE);
 619   8                                                                              }
 620   7                                                                              else if (MV_CS) {
 621   8      
 622   8                                                                                      setventmotor(VENT_MOTOR_STOP);
 623   8                                                                                      ventstate = VENT_ERROR;
 624   8                                                                                      swventpressed = 0;
 625   8                                                                                      swventpressed1 = 0;
 626   8      
 627   8                                                                              }
 628   7      
 629   7                                                                              break;
 630   7                                                                      }
 631   6      
 632   6                                      case VENT_ERROR: {
 633   7                                              if (swventpressed) {
 634   8      
 635   8                                                      swventpressed = 0;
 636   8      
 637   8                                                      ventstate = VENT_OUT_STARTING;
 638   8                                                      setventmotor(VENT_MOTOR_OUT);
 639   8      
 640   8                                              }
 641   7      
 642   7                                              break;
 643   7      
 644   7                                      }
 645   6      
 646   6                                      }
 647   5                              }
 648   4      
 649   4                              TASK_select++;
 650   4                              break;
 651   4                      }
 652   3                      case TASK3: {
 653   4                              if (millis - checkTimer3 > 10) {
 654   5                                      button_state = SW_LID;
 655   5      
 656   5                                      if (!button_state && last_sw_lid_state) {
 657   6                                              swlidpressed = 1;
 658   6      
 659   6                                      }
 660   5      
 661   5                                      // Update last button state
 662   5                                      last_sw_lid_state = button_state;
 663   5      
 664   5                                      button_state1 = SW_VENT;
 665   5      
 666   5                                      if (!button_state1 && last_sw_vent_state) {
 667   6                                              if (lidstate == LID_OPEN || lidstate == LID_OPENING) swventpressed = 1;
 668   6                                      }
 669   5      
 670   5                                      // Update last button state
 671   5                                      last_sw_vent_state = button_state1;
 672   5      
 673   5                                      checkTimer3 = millis;
 674   5                                      //LED_LID = !LED_LID;
 675   5      
 676   5                              }
 677   4                              TASK_select++;
 678   4                              break;
 679   4                      }
 680   3                      case TASK4: {
C51 COMPILER V9.53.0.0   FIRMWARE_IC_VENT_MAIN                                             04/14/2023 15:18:04 PAGE 12  

 681   4      
 682   4                              if (millis - checkTimer2 > 2) {
 683   5      
 684   5                                      if (ML_CS && lidstate!=LID_ERROR) {
 685   6      
 686   6                                              LED_LID = 0;
 687   6      
 688   6                                      } else if (lidstate!=LID_ERROR) {
 689   6                                              LED_LID = 1;
 690   6      
 691   6                                      }
 692   5      
 693   5                                      if (MV_CS && ventstate!=VENT_ERROR) {
 694   6      
 695   6                                              LED_VENT = 0;
 696   6      
 697   6                                      } else if (ventstate!=VENT_ERROR) {
 698   6                                              LED_VENT = 1;
 699   6      
 700   6                                      }
 701   5      
 702   5                                      checkTimer2 = millis;
 703   5      
 704   5                              }
 705   4                              if (checkTimer4 - millis > 1000) {
 706   5      
 707   5                                      if (!RAIN_IN) {
 708   6                                              LED_RAIN = 0;   // rain detected
 709   6                                              if (ventstate == VENT_OUT || ventstate == VENT_IN) {
 710   7                                                      ventstate = VENT_STOPPED;
 711   7                                                      setventmotor(VENT_MOTOR_STOP);
 712   7                                              }
 713   6      
 714   6                                              if (lidstate != LID_CLOSED && lidstate != LID_CLOSING
 715   6                                                              && lidstate != LID_CLOSING_STARTING) {
 716   7                                                      lidstate = LID_CLOSING_STARTING;
 717   7                                                      setlidmotor(LID_MOTOR_CLOSE);
 718   7                                                      timerlid = millis;
 719   7                                              }
 720   6      
 721   6                                      } else {
 722   6                                              LED_RAIN = 1;
 723   6                                      }
 724   5                                      if (lidstate == LID_CLOSED ) {
 725   6                                              if (ventstate == VENT_OUT || ventstate == VENT_IN){
 726   7                                                      swventpressed = 0;
 727   7                                                      ventstate = VENT_STOPPING;
 728   7                                                      setventmotor(VENT_MOTOR_BRAKE);
 729   7      
 730   7                                              }
 731   6                                      }
 732   5                                      checkTimer4 = millis;
 733   5      
 734   5                              }
 735   4      
 736   4                              TASK_select++;
 737   4                              break;
 738   4                      }
 739   3                      case TASK5: {
 740   4      
 741   4                              if (millis - checkTimer5 > 500) {
 742   5      
 743   5                                      checkTimer5 = millis;
C51 COMPILER V9.53.0.0   FIRMWARE_IC_VENT_MAIN                                             04/14/2023 15:18:04 PAGE 13  

 744   5                                      if (lidstate == LID_ERROR) {
 745   6                                              LED_LID = !LED_LID;
 746   6      
 747   6                                      }
 748   5      
 749   5                                      if (ventstate == VENT_ERROR) {
 750   6                                              LED_VENT = !LED_VENT;
 751   6                                      }
 752   5      
 753   5                              }
 754   4      
 755   4                              TASK_select++;
 756   4                              break;
 757   4                      }
 758   3                      default: {
 759   4      
 760   4                              if (newKey == 0x20df40bf)  //volume up
 761   4                                      {
 762   5      
 763   5                                              oldKey = newKey;
 764   5                                              newKey = 0;
 765   5                                              if (!swlidpressed && (lidstate == LID_CLOSED)  ) swlidpressed = 1;
 766   5      
 767   5      
 768   5      
 769   5                              }
 770   4                              if (newKey == 0x20dfc03f)  //volume down
 771   4                                                              {
 772   5      
 773   5                                                                      oldKey = newKey;
 774   5                                                                      newKey = 0;
 775   5                                                                      if (!swlidpressed && (lidstate == LID_OPEN)   ){
 776   6                                                                              swlidpressed = 1;
 777   6                                                                              if (!swventpressed && (ventstate == VENT_IN || ventstate == VENT_OUT || ventstate==VENT_IN_STARTI
             -NG || ventstate ==VENT_IN_STARTING )){
 778   7                                                                                      swventpressed = 1;
 779   7      
 780   7                                                                              }
 781   6      
 782   6                                                                      }
 783   5      
 784   5      
 785   5      
 786   5                                                      }
 787   4                              else if (newKey == 0x20df00ff) //Channel up
 788   4                              {
 789   5      
 790   5                                      oldKey = newKey;
 791   5                                      newKey = 0;
 792   5      
 793   5                                      if (!swventpressed && (ventstate == VENT_STOPPED) && (lidstate == LID_OPEN || lidstate == LID_OPENING 
             -) ) swventpressed = 1;
 794   5      
 795   5      
 796   5                      }
 797   4                              else if (newKey == 0x20df807f) //0x20df807f - channel down
 798   4                                              {
 799   5      
 800   5                                                      oldKey = newKey;
 801   5                                                      newKey = 0;
 802   5      
 803   5                                                      if (!swventpressed && (ventstate == VENT_OUT || ventstate == VENT_IN ) && (lidstate == LID_OPEN || l
             -idstate == LID_OPENING )  ) swventpressed = 1;
C51 COMPILER V9.53.0.0   FIRMWARE_IC_VENT_MAIN                                             04/14/2023 15:18:04 PAGE 14  

 804   5      
 805   5      
 806   5                                      }
 807   4                              else if (newKey == 0x20df14eb) //0x20df807f - back button
 808   4                                                              {
 809   5      
 810   5                                                                      oldKey = newKey;
 811   5                                                                      newKey = 0;
 812   5      
 813   5                                                                      if (!swventpressed1 && (ventstate == VENT_STOPPED && (lidstate == LID_OPEN || lidstate == LID_OPEN
             -ING ) )  ) swventpressed1 = 1;
 814   5      
 815   5      
 816   5                                                      }
 817   4                              else if (newKey == 0x20df10ef)  //power button
 818   4                                                      {
 819   5      
 820   5                                                              oldKey = newKey;
 821   5                                                              newKey = 0;
 822   5      
 823   5                                                                                                              if (!swlidpressed && (lidstate == LID_CLOSED)  ) swlidpressed = 1;
 824   5                                                                                                              if (!swventpressed && (ventstate == VENT_STOPPED )  ) swventpressed = 1;
 825   5      
 826   5      
 827   5                                              }
 828   4                              else if (newKey == 0x20dfc23d)  //menu button
 829   4                                                                      {
 830   5      
 831   5                                                                              oldKey = newKey;
 832   5                                                                              newKey = 0;
 833   5      
 834   5                                                                              if (!swlidpressed && (lidstate == LID_OPEN)  ) swlidpressed = 1;
 835   5                                                                              if (!swventpressed && (ventstate == VENT_OUT )  ) swventpressed = 1;
 836   5      
 837   5      
 838   5                                                              }
 839   4      
 840   4      
 841   4      
 842   4      
 843   4                              //0x20df00ff - channel up
 844   4                              //0x20df807f - chanel down
 845   4                              //0x20df02fd - arrow up
 846   4                              //0x20df827d - arrow down
 847   4                              //0x20df609f - arrow right
 848   4                              //0x20df22dd - ok
 849   4                              //0x20dfc23d - menu
 850   4                              //0x20df14eb - back
 851   4                              TASK_select = 0;
 852   4                              break;
 853   4                      }
 854   3                      }
 855   2      
 856   2              }
 857   1      }
 858          // $[Generated Run-time code]
 859          // [Generated Run-time code]$
 860          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   3115    ----
   CONSTANT SIZE    =   ----    ----
C51 COMPILER V9.53.0.0   FIRMWARE_IC_VENT_MAIN                                             04/14/2023 15:18:04 PAGE 15  

   XDATA SIZE       =     38    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     51    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      7    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
